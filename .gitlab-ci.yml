variables: 
  WORKDIR: /var/deploy/${CI_COMMIT_BRANCH}/${CI_COMMIT_SHORT_SHA}
  DIR_TEST: /var/www/new.rent.myauto.ge
stages:
  - main
  - staging
  - test

build-main:
    stage: main
    only:
      - main
    tags:
      - front-rent      
    script:
        - rsync -tar --exclude='.git*' --exclude='readme.md'  --stats --no-perms . ${WORKDIR}
        - echo "${ENV}" > ${WORKDIR}/src/env.js
        - echo "${ECOSYSTEM}" > ${WORKDIR}/ecosystem.config.js
        - cd ${WORKDIR} && yarn
        - cd ${WORKDIR} && yarn build
        - ln -sfT ${WORKDIR} ${DIR}
        - cd ${DIR} && (pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js)
        - cd /var/deploy/${CI_COMMIT_BRANCH} && ls -t | tail -n +3 | sudo xargs -I {} rm -r {}

build-staging:
    stage: staging
    only:
      - staging
    tags:
      - front-rent
    script:
        - rsync -tar --exclude='.git*' --exclude='readme.md'  --stats --no-perms . ${WORKDIR}
        - echo "${ENV_STAGING}" > ${WORKDIR}/src/env.js
        - echo "${ECOSYSTEM_STAGING}" > ${WORKDIR}/ecosystem.config.js
        - cd ${WORKDIR} && yarn
        - cd ${WORKDIR} && yarn build
        - ln -sfT ${WORKDIR} ${DIR_STAGING}
        - cd ${DIR_STAGING} && (pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js)
        - cd /var/deploy/${CI_COMMIT_BRANCH} && ls -t | tail -n +3 | sudo xargs -I {} rm -r {}

build-test:
    stage: test
    only:
      - test
    tags:
        - front-rent
    script:
        - rsync -tar --exclude='.git*' --exclude='readme.md'  --stats --no-perms . ${WORKDIR}
        - echo "${ENV_TEST}" > ${WORKDIR}/src/env.js
        - echo "${ECOSYSTEM_TEST}" > ${WORKDIR}/ecosystem.config.js
        - cd ${WORKDIR} && yarn
        - cd ${WORKDIR} && yarn build
        - ln -sfT ${WORKDIR} ${DIR_TEST}
        - cd ${DIR_TEST} && (pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js)
        - cd /var/deploy/${CI_COMMIT_BRANCH} && ls -t | tail -n +3 | sudo xargs -I {} rm -r {}